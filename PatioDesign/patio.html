<html>

<body>
    <h1 style="text-align:center"> Homework 4 Demo </h1>
    <hr>
    <div id="container" style="float:left; margin:3px; width:60vw; height:60vw">
    </div>

    <div style="float:left; margin-left: 10px; width:32vw;">

        <div>
            Furniture Size:
            <input id="radius" type="range" min=0 max=30 value=15>
            <span id='radiusPrint'>
            </span>
            <br>
        </div>
        <br>
        <div style='background-color:pink'>
            Status Selector:
            <br>
            <input type=radio class='gclass' id='placing' name='g' value='place' checked> Place <br>
            <input type=radio class='gclass' name='g' value='move'> Move<br>
            <input type=radio class='gclass' name='g' value='delete'> Delete<br>
        </div>
        <br>
        <button id='clear' style="width:45%">Clear</button>
        <button id='save' style="width:45%">Save</button>
        <button id='restore' style="width:45%">Restore</button>
    </div>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://threejs.org/build/three.min.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>

</body>
<style>

</style>
<script>

    $('#radius').change(function () {
        $('#radiusPrint').text($(this).val());
    });



    var camera, scene, renderer, controls;
    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();
    var pickplane;
    var cyl;
    var furnitures = [];
    var userStatus = "place";

    init();
    animate();

    $('.gclass').click(function () {
        if ($(this).val() === 'place') {
            userStatus = "place";
        } else if ($(this).val() === 'move') {
            userStatus = "move";
        } else {
            // delete
            userStatus = "delete";
        }
    });

    $('#clear').click(function () {

        furnitures.forEach(function (sphere) {
            scene.remove(sphere);
        });

        furnitures = [];

    });

    $('#save').click(function () {

        var states = [];

        furnitures.forEach(function (sphere) {
            states.push(sphere.name);
        });

        localStorage.setItem('stateStr', JSON.stringify(states));

    });

    $('#restore').click(function () {

        var states = JSON.parse(localStorage.getItem('stateStr'));

        states.forEach(function (stateStr) {
            console.log(stateStr);
            var state = JSON.parse(stateStr);
            if (state.type === "chair") {
                buildChair(state.size, new THREE.Vector3(state.pos[0], 0, state.pos[1]));
            }

        });

    });

    function buildChair(size, pos) {

        var chair = new THREE.Mesh(new THREE.SphereGeometry(size, 20, 20), new THREE.MeshNormalMaterial());

        scene.add(chair);

        var prop = {
            type: "chair",
            size: size,
            pos: [pos.x, pos.z]
        };

        console.log(prop);
        chair.name = JSON.stringify(prop);
        console.log(chair.name);

        furnitures.push(chair);
        chair.position.copy(pos);

    }

    function init() {

        var ww = $("#container").innerWidth();
        var hh = $("#container").innerHeight();
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(ww, hh);
        renderer.setClearColor(0x888888);
        $("#container").append(renderer.domElement);

        ////////////////////////////////////////////////

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(50, ww / hh, 1, 1000);
        camera.position.z = 500;
        scene.add(camera);

        var cyl_geom = new THREE.RingGeometry(5, 10, 32);
        var cyl_mat = new THREE.MeshBasicMaterial({
            color: 0xff1234,
        });
        cyl = new THREE.Mesh(cyl_geom, cyl_mat);
        cyl.rotation.x = -Math.PI / 2;
        cyl.position.set(-20, 0, 20);
        scene.add(cyl);

        pickplane = new THREE.Mesh(new THREE.PlaneGeometry(200, 200),
            new THREE.MeshBasicMaterial({
                color: 0xff1234
            }));
        pickplane.rotation.x = -Math.PI / 2;
        scene.add(pickplane);
        pickplane.material.visible = false;

        var gridXZ = new THREE.GridHelper(200, 20, 'red', 'white');
        scene.add(gridXZ);

        controls = new THREE.OrbitControls(camera, renderer.domElement);

        window.addEventListener('resize', onWindowResize, false);
        window.addEventListener('mousemove', onDocumentMouseMove, false);
        window.addEventListener('mousedown', onDocumentMouseDown, true);
    }

    function onWindowResize() {
        var ww = $("#container").innerWidth();
        var hh = $("#container").innerHeight();

        camera.aspect = ww / hh;
        camera.updateProjectionMatrix();
        renderer.setSize(ww, hh);
    }

    function onDocumentMouseMove(event) {

        event.preventDefault();

        var viewportPos = $('#container').get(0).getBoundingClientRect();
        mouse.x = ((event.clientX - viewportPos.left) / $('#container').innerWidth()) * 2 - 1;
        mouse.y = -((event.clientY - viewportPos.top) / $('#container').innerHeight()) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObject(pickplane);

        if (intersects.length > 0) {
            cyl.position.copy(intersects[0].point);
            cyl.position.y = 2;
        }
    }

    function onDocumentMouseDown(event) {

        // event.preventDefault();

        var viewportPos = $('#container').get(0).getBoundingClientRect();
        mouse.x = ((event.clientX - viewportPos.left) / $('#container').innerWidth()) * 2 - 1;
        mouse.y = -((event.clientY - viewportPos.top) / $('#container').innerHeight()) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);

        if (userStatus === "place") { // place

            console.log("now placing");

            var intersects = raycaster.intersectObject(pickplane);

            if (intersects.length > 0) {
                cyl.position.copy(intersects[0].point);
                buildChair(15, intersects[0].point);
            }
        } else { // delete

            console.log("now deleting");

            var intersects = raycaster.intersectObjects(furnitures);

            if (intersects.length > 0) {
                let theFurniture = intersects[0].object;

                //scene.remove(thePuck);
                theFurniture.removeFromParent();

                // remove thePuck from pucks
                for (let i = 0; i < furnitures.length; i++) {
                    if (furnitures[i] === theFurniture) {
                        furnitures.splice(i, 1);
                        break;
                    }
                }

            }

        }

    }

    function animate() {

        controls.update();
        requestAnimationFrame(animate);
        render();
    }

    function render() {
        renderer.render(scene, camera);
    }

</script>

</html>